<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Civic Return</title>
    <meta
      name="description"
      content="Find your green space per resident in Kentucky."
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #f6f2e9;
        --bg-2: #e9dfc9;
        --ink: #21301f;
        --accent: #7f9b6a;
        --accent-ink: #f6f2e9;
        --card: #fffdf8;
        --muted: #65725f;
        --border: #e4ddcf;
        --focus: #3b6d3e;
        --radius: 16px;
        --shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: Montserrat, system-ui, sans-serif;
        color: var(--ink);
        background: linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
      }

      .container {
        max-width: 640px;
        margin: 0 auto;
        padding: 20px 16px 64px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 24px 20px;
        box-shadow: var(--shadow);
      }

      header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 8px;
        justify-content: center;
        text-align: center;
      }

      .logo {
        width: 96px;
        height: 96px;
        border-radius: 12px;
        object-fit: contain;
        background: #e7e4d9;
      }
      .brand h1 {
        font-size: 28px;
        font-weight: 900;
        margin: 0;
      }

      .lead {
        text-align: center;
        margin: 12px 8px 24px;
      }
      .lead h2 {
        margin: 0 0 8px;
        font-size: 28px;
        line-height: 1.15;
        font-weight: 800;
      }
      .lead p {
        color: var(--muted);
        margin: 0;
      }

      .form {
        display: grid;
        gap: 14px;
        margin-top: 16px;
      }

      label {
        font-weight: 600;
      }

      select,
      button {
        width: 100%;
        font: inherit;
        border-radius: 12px;
        padding: 14px 12px;
        border: 1px solid var(--border);
        background: white;
      }

      select:focus,
      button:focus {
        outline: none;
        box-shadow: 0 0 0 3px color-mix(in oklab, var(--focus) 35%, white);
        border-color: var(--focus);
      }

      .button {
        background: var(--accent);
        color: var(--accent-ink);
        border: none;
        font-weight: 700;
        letter-spacing: 0.3px;
        cursor: pointer;
      }

      .button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .rule {
        border: 0;
        height: 1px;
        background: var(--border);
        margin: 24px 0;
      }

      .result {
        display: none;
        margin-top: 12px;
        background: #f3f0e6;
        border: 1px dashed var(--border);
        padding: 16px;
        border-radius: 12px;
      }
      .result.show {
        display: block;
      }
      .result h3 {
        margin: 0 0 6px;
        font-size: 20px;
        font-weight: 800;
      }
      .metric {
        margin: 6px 0;
        font-size: 16px;
      }
      .metric span {
        font-weight: 700;
      }
      .note {
        color: var(--muted);
        font-size: 14px;
        margin-top: 6px;
      }

      footer {
        margin-top: 28px;
        text-align: center;
        color: var(--muted);
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <main class="container">
      <section class="card" aria-labelledby="title">
        <header>
          <img
            class="logo"
            src="assets/civic-return-logo.jpg"
            alt="Civic Return logo"
          />
          <div class="brand">
            <h1 id="title">CIVIC RETURN</h1>
          </div>
        </header>

        <div class="lead">
          <h2>Find Your Green Space</h2>
          <p>
            Select your county in Kentucky to calculate your share of public
            green space.
          </p>
        </div>

        <form class="form" id="form" novalidate>
          <label for="county">County</label>
          <select id="county" required>
            <option value="" selected>Select a county…</option>
            <option value="067">Fayette</option>
            <option value="111">Jefferson</option>
            <!-- full list already inserted in prior update -->
          </select>
          <button class="button" id="calc" disabled>Calculate</button>
        </form>

        <div id="result" class="result" role="status" aria-live="polite">
          <h3 id="county-name">Results</h3>
          <p class="metric" id="pop">Population: <span>–</span></p>
          <p class="metric" id="green">Green space area: <span>–</span></p>
          <p class="metric" id="per">Sq ft per resident: <span>–</span></p>
          <p class="note">
            Data sources: Census ACS (population), OpenStreetMap (parks, later).
          </p>
        </div>

        <hr class="rule" />
        <footer>
          <small
            >Made in Kentucky by
            <a href="https://sleepingbear.us">Sleeping Bear Labs</a> • Method:
            OSM (parks) + Census ACS (population)</small
          >
        </footer>
      </section>
    </main>

    <!-- OSM JSON -> GeoJSON -->
    <script src="https://unpkg.com/osmtogeojson@3.0.0/osmtogeojson.js"></script>
    <!-- Turf for area calculation -->
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

    <script>
      const county = document.getElementById("county");
      const calc = document.getElementById("calc");
      const result = document.getElementById("result");
      const countyName = document.getElementById("county-name");
      const popEl = document.getElementById("pop").querySelector("span");
      const greenEl = document.getElementById("green").querySelector("span");
      const perEl = document.getElementById("per").querySelector("span");

      county.addEventListener("change", () => {
        calc.disabled = !county.value;
      });

      async function fetchParksAreaSqFt(countyName) {
        // Overpass: KY admin area -> this county -> parks within
        const ql = `
    [out:json][timeout:120];
    area["ISO3166-2"="US-KY"]->.ky;
    area.ky["boundary"="administrative"]["admin_level"="6"]["name"="${countyName} County"]->.county;
    ( way(area.county)["leisure"="park"];
      rel(area.county)["leisure"="park"]; );
    out body;
    >;
    out skel qt;
  `;
        const resp = await fetch("https://overpass-api.de/api/interpreter", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: "data=" + encodeURIComponent(ql.trim()),
        });
        if (!resp.ok) throw new Error("Overpass error " + resp.status);
        const osmJson = await resp.json();
        const gj = osmtogeojson(osmJson);

        // Keep only polygonal features
        const polys = {
          type: "FeatureCollection",
          features: gj.features.filter(
            (f) =>
              f.geometry &&
              (f.geometry.type === "Polygon" ||
                f.geometry.type === "MultiPolygon")
          ),
        };

        // Sum area (m²) and convert to ft²
        const totalSqM = polys.features.reduce(
          (sum, f) => sum + turf.area(f),
          0
        );
        return totalSqM * 10.7639;
      }

      // Placeholder for later — will fetch and compute green space area
      async function fetchParksAreaSqFt(countyName) {
        // For now, just return 0 to prove the wiring works
        return 0;
      }

      document.getElementById("form").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!county.value) return;

        const name = county.options[county.selectedIndex].textContent;
        const fips = county.value;

        result.classList.add("show");
        countyName.textContent = name + " County";
        popEl.textContent = "…";
        greenEl.textContent = "loading…";
        perEl.textContent = "loading…";
        calc.disabled = true;

        try {
          // 1. Census population
          const url = `https://api.census.gov/data/2023/acs/acs5?get=NAME,B01003_001E&for=county:${fips}&in=state:21`;
          const resp = await fetch(url);
          const data = await resp.json();
          const pop = Number((data && data[1] && data[1][1]) || 0);
          popEl.textContent = new Intl.NumberFormat("en-US").format(pop);

          // 2 + 3. Parks area + per-resident calc
          try {
            const sqFt = await fetchParksAreaSqFt(name);
            greenEl.textContent = new Intl.NumberFormat("en-US", {
              maximumFractionDigits: 0,
            }).format(Math.round(sqFt));

            if (pop > 0) {
              const per = sqFt / pop;
              perEl.textContent = new Intl.NumberFormat("en-US", {
                maximumFractionDigits: 1,
              }).format(per);
            } else {
              perEl.textContent = "n/a";
            }
          } catch (e) {
            console.error(e);
            greenEl.textContent = "error";
            perEl.textContent = "error";
          }
        } catch (err) {
          console.error(err);
          popEl.textContent = "error";
        } finally {
          calc.disabled = false;
        }
      });
    </script>
  </body>
</html>
